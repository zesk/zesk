#!/usr/bin/env sh
#
#   _____         _
#  |__  /___  ___| | __
#    / // _ \/ __| |/ /
#   / /|  __/\__ \   <
#  /____\___||___/_|\_\
#
# Binary shell - finds PHP and a Zesk application and runs it.
# Supports all Zesk installations.
# Searches upwards from current directory to find a *.application.php file
# Supports parsing of `--cd` and `--search` to find Zesk (simple - use these first on your CLI)
#
# Use sh to avoid having to install bash on virgin systems
#
# `zesk help` for more help
#
err_env=1
err_arg=1
ERR_NO_VENDOR=1002
ERR_NO_ZESK_BIN=1003

#DEBUG
#set -x

export PATH=$PATH:/usr/bin:/bin:/usr/local/bin

extractCD() {
  while [ $# -gt 1 ]; do
    case $1 in
      # looking for these
      "--cd" | "--search" )
        shift
        echo "$1"
        ;;
      # --arg var
      "--unset" | "--set" | "--config" | "--define" )
        shift
        ;;
      # --name=value
      "--[a-z]+=*")
        return 0
        ;;
      *)
        return 0
    esac
    shift
  done
}

findAppRoot() {
  targetVariable="$1"
  shift
  start="$1"
  if ! cd "$start" 2> /dev/null; then
    echo "Unable to change directory to \"$start\"" 1>&2
    return 1
  fi
  current=
  next="$start"
  while [ "$next" != "$current" ]; do
    current="$next"
    if ls ./*.application.php 1> /dev/null 2>&1; then
      eval "$targetVariable=$current"
      return 0
    fi
    cd ..
    next=$(pwd)
  done
  return 0
}

findFirstAppRoot() {
  targetVariable2="$1"
  shift
  tryDir=
  while read -r tryDir; do
    appRoot=
    if findAppRoot appRoot $tryDir; then
      if [ -n "$appRoot" ]; then
        eval "$targetVariable2=$appRoot"
        return 0
      fi
    else
      return 1
    fi
  done
  return 0
}

here=$(dirname "$0")
php=$(which php)
if [ -z "$php" ]; then
	echo "PHP is not found in PATH: $PATH" 1>&2
	exit $err_env
fi

# DEBUG
# echo "extractCD: $(extractCD "$@")EOL"

appRoot=
if ! extractCD "$@" | findFirstAppRoot appRoot; then
  exit $err_arg
fi

cd "$start" || exit $err_env
if [ -z "$appRoot" ]; then
	cd "$here" || exit $err_env
	cd .. || exit $err_env
	appRoot=$(pwd)
	cd "$start" || exit $err_env
fi
for binary in "$appRoot/bin/zesk-command.php" "$appRoot/vendor/bin/zesk-command.php"; do
	if [ -x "$binary" ]; then
		exec "$php" "$binary" "$@"
	fi
done
if [ ! -d "$appRoot/vendor/bin/" ]; then
	echo "No vendor directory exists, run: composer require zesk/zesk && composer install" 1>&2
	exit $ERR_NO_VENDOR
fi
echo "No zesk command file, run: composer require zesk/zesk && composer install" 1>&2
exit $ERR_NO_ZESK_BIN
