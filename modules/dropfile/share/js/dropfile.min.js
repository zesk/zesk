!function(e,$){"use strict";var t=e.zesk,s=e.html,i=e.document,r=e.avalue,n=e.is_object,a=e.to_integer,l=e.to_list,o=e.__||function(e){return(arguments[1]||{}).map(e.right(":=",e))},c="dropfile",u="."+c+"[data-"+c+"-url]",h=0,p=!1,f=null,d="."+c,m=t.get("modules."+c+".document_target_class","dropfile-document-target"),g=function(e){return e.toString().replace(/\\/g,"/").rright("/")},_={column:"file",url:null,max_files:10,target:null,accept:null,enabled_class:"dropfile-enabled",target_class:"dropfile-target",active_class:"dropfile-active",allowed_types:null,start:function(e){this.progress_start(e)},progress:function(e){this.progress_progress(e)},success:function(e){this.progress_success(e)},type_error:function(e){$.each(e,function(){t.message(o("DropFile:=The file {file} was not uploaded because it is the wrong type. ({type})",{file:g(this.name),type:this.type}))})},max_error:function(e){var s=this;$.each(e,function(){t.message(o("DropFile:=The file {name} was not uploaded because you can only upload {n} files maximum.",{file:g(this.name),n:s.max_files}))})},error:function(){$(".dropfile-progress",this.$element).remove()}},v=function(e,t){var s=this;t=n(t)?t:{},this.$element=e,$.each(_,function(i){s[i]=r(t,i,e.data(c+i.toCamelCase())||this)}),this.target_class=this.target_class||c+"-target",this.allowed_types=l(this.allowed_types,null),this.url||(this.url=e.parents("form").attr("action"),this.url||(this.url=i.URL)),this.url+=(this.url.indexOf("?")<0?"?":"&")+"ajax=1",this.max_files=Math.min(a(this.max_files),1),this.queue=[],this.has_input=!1,$.each(["dragover","dragleave","drop","click"],function(){var t=this;e.off(t+d).on(t+d,function(e){s[t](e)})}),this.setup_file_input(),this.enabled_class&&e.addClass(this.enabled_class)};$.extend(v.prototype,{setup_file_input:function(){var e="",i=this,r=this.$input,n;$("form input",this.$element).length>0||(this.accept&&(e=' acccept="'+s.encode(this.accept)+'"'),this.$element.append('<form action="'+this.url+'" method="post" target="dropfile-'+this.column+'" enctype="multipart/form-data"><input type="file" name="'+this.column+'"'+e+' /><iframe name="dropfile-'+this.column+'" style="display: none"></iframe><input type="hidden" name="ok" value="ok" /></form>'),r=$("form input",this.$element),r.on("change",function(){t.log("file.change"),r.val()&&(i.call_start({name:g(r.val())}),i.progress&&i.progress(0),this.form.submit())}).on("focus",function(){t.log("file.focus")}).on("blur",function(){t.log("file.blur")}),n=$("iframe",this.$element),n.on("load",function(){var e=$.parseJSON(n.contents().find("body").text());i.progress(100),i.call_success(e),i.reset_file_input()}))},reset_file_input:function(){$("form",this.$element).remove(),this.setup_file_input()},click:function(){},dragover:function(e){e.stopPropagation(),e.preventDefault(),this.over||(this.$element.addClass(this.target_class),this.over=!0)},dragleave:function(e){e.stopPropagation(),e.preventDefault(),this.over&&(this.$element.removeClass(this.target_class),this.over=!1)},drop:function(e){var t=e.originalEvent.dataTransfer.files;e.preventDefault(),this.$element.removeClass(this.target_class),this.over=!1,f&&(clearTimeout(f),f=null),this.upload_files(t)},valid_file:function(e){var s,i;if(!this.allowed_types)return!0;for(s=0;s<this.allowed_types.length;s++)if(i=this.allowed_types[s],i.indexOf("/")>0){if(e.type===i)return!0}else if(0===i.indexOf("/")){if(e.type.ends(i))return!0}else if(e.type.begins(i))return!0;return t.log("Skipping "+e.name+" - not of type "+this.allowed_types),!1},upload_files:function(e){var t,s,i=[],r=[],n=0;for(t=0;t<e.length;t++)this.valid_file(e[t])?n>this.max_files?r.push(e[t]):(s=new FormData,s.append(this.column,e[t]),this.call_start(e[t]),this.upload(s),++n):i.push(e[t]);this.type_error&&i.length&&this.type_error.call(this,i),this.max_error&&r.length&&this.max_error.call(this,r)},call_start:function(e){this.start&&this.start.call(this,e)},call_success:function(e){this.progress&&this.progress(100),this.success?this.success(e):t.handle_json(e),this.setup_file_input()},upload:function(e){var t=this;this.xhr=$.ajax(this.url,{xhr:function(){var e=$.ajaxSettings.xhr();return e.upload&&t.progress&&e.upload.addEventListener("progress",function(e){var s=0,i=e.loaded||e.position,r=e.total;e.lengthComputable&&(s=Math.ceil(i/r*100)),t.progress.call(t,s)},!1),e},type:"POST",contentType:!1,processData:!1,cache:!1,data:e,success:function(e){t.call_success(e)},error:function(){t.error&&t.error()}})},progress_start:function(e){var t=e.name;this.filename=t,this.$element.prepend('<div class="progress"><div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%;"><span class="sr-only">60%</span></div><div class="dropfile-name">'+t+"</div></div>"),$(this.$element).removeClass(m).removeClass(this.target_class),$(this.$element).addClass(this.active_class)},progress_progress:function(e){$(".progress .progress-bar",this.$element).css("width",e+"%"),$(".progress .progress-bar .sr-only",this.$element).html(e+"%")},progress_success:function(e){$(".progress",this.$element).remove(),$(this.$element).removeClass(this.active_class),this.target&&$(this.target).html(e.content),t.handle_json(e)}}),$.fn[c]=function(e){$(this).each(function(){var t=$(this);h++,t.data(c,new v(t,e))})},$.extend(_,t.get_path("modules."+c,{})),$.extend({dropfile:function(e){$(u)[c](e)}}),$.each({dragover:function(){p||($(u).addClass(m),p=!0)},dragleave:function(){p&&($(u).removeClass(m),p=!1)},drop:function(e){if(p){var t=$(u).data(c);t&&(f=setTimeout(function(){t.drop(e),f=null},500))}}},function(e){var s=this;$(i).on(e,function(i){h&&(t.log("document."+e),i.stopPropagation(),i.preventDefault(),s(i))})})}(window,window.jQuery);